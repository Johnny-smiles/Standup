<?php

namespace Tests\Unit\SlackModal\ModalOpen;

use App\Models\Workday;
use App\Support\Slack\Requests\Exceptions\MissingChannelIdException;
use App\Support\Slack\Requests\Exceptions\MissingTriggerIdException;
use App\Support\Slack\Requests\SlackDataTransferObject;
use App\Support\Slack\Requests\SlackRequest;
use App\Support\Slack\Requests\Triggers\Open\TriggerOpen;
use App\Support\Slack\Requests\Triggers\Open\Views\EndOfDayView;
use App\Support\Slack\Requests\Triggers\Open\Views\StartOfDayView;
use App\Support\Slack\Requests\Triggers\Open\Views\WelcomeView;
use Tests\TestCase;
use Tests\Unit\SlackModal\MockBuilder;

class ModalOpenTest extends TestCase
{
    use MockBuilder;

    protected Workday $workday;

    protected function setUp(): void
    {
        parent::setUp();

        $this->workday = Workday::factory()->statusCompleted()->create();
    }

    /** @test */
    public function it_calls_modal_open()
    {
        $this->mockBuilder(
            TriggerOpen::class,
            'handleSlackRequest',
        );

        (new SlackRequest([
            'user_id' => $this->workday->user->slack_id,
            'user_name' => $this->workday->user->slack_username,
            'team_id' => $this->workday->channel->team->team_id,
        ]))->handle();
    }

    /** @test */
    public function it_requires_trigger_id()
    {
        $this->expectException(MissingTriggerIdException::class);

        (new WelcomeView())
            ->buildResponse(
                (new SlackDataTransferObject(
                    []
                ))
            );
    }

    /** @test */
    public function it_requires_channel_id()
    {
        $this->expectException(MissingChannelIdException::class);

        (new WelcomeView())
            ->buildResponse(
                (new SlackDataTransferObject(
                    ['trigger_id' => 'id']
                ))
            );
    }

    /** @test */
    public function it_calls_welcome_modal()
    {
        $this->mockBuilder(
            WelcomeView::class,
            'buildResponse',
        );

        $withDeletedWorkday = $this->transferObjectBuilder($this->workday);

        $this->workday->delete();

        $withDeletedWorkday->setWorkday();

        (new TriggerOpen($withDeletedWorkday))->handleSlackRequest();
    }

    /** @test */
    public function it_calls_start_of_day_modal()
    {
        $this->mockBuilder(
            StartOfDayView::class,
            'buildResponse',
        );

        (new TriggerOpen($this->transferObjectBuilder($this->workday)))->handleSlackRequest();
    }

    /** @test */
    public function it_calls_end_of_day_modal()
    {
        $this->workday->update(['completed' => false]);

        $this->mockBuilder(
            EndOfDayView::class,
            'buildResponse',
        );

        (new TriggerOpen($this->transferObjectBuilder($this->workday)))->handleSlackRequest();
    }

    protected function transferObjectBuilder(Workday $workday): SlackDataTransferObject
    {
        return (new SlackDataTransferObject([
            'channel_id' => $workday->channel->slack_channel_id,
            'channel_name' => $workday->channel->name,
            'user_id' => $workday->user->slack_id,
            'user_name' => $workday->user->slack_username,
            'team_id' => $workday->channel->team->team_id,
            'trigger_id' => '25014SDF23682.22586511SDF59.64488ed92b33d5SDFSDF5c09cd351be4',
        ]
        ))
            ->setAndUpdateUser()
            ->setTeam()
            ->setBotToken()
            ->setWorkday();
    }
}
